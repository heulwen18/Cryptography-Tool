<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mã hóa ElGamal với Khóa Ngẫu Nhiên</title>
    <script>
        // Hàm kiểm tra số nguyên tố
        function isPrime(num) {
            if (num <= 1) return false;
            if (num <= 3) return true;
            if (num % 2 === 0 || num % 3 === 0) return false;
            let i = 5;
            while (i * i <= num) {
                if (num % i === 0 || num % (i + 2) === 0) return false;
                i += 6;
            }
            return true;
        }

        // Hàm sinh số nguyên tố ngẫu nhiên trong khoảng [min, max)
        function generateRandomPrime(min, max) {
            let prime;
            do {
                prime = randomInt(min, max);
            } while (!isPrime(prime));
            return prime;
        }

        // Hàm sinh số nguyên ngẫu nhiên trong khoảng [min, max)
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        // Hàm tìm căn nguyên thủy của p
        function findPrimitiveRoot(p) {
            const phi = p - 1;
            const factors = getPrimeFactors(phi);

            for (let g = 2; g < p; g++) {
                let isPrimitiveRoot = true;
                for (let factor of factors) {
                    if (modExp(g, phi / factor, p) === 1) {
                        isPrimitiveRoot = false;
                        break;
                    }
                }
                if (isPrimitiveRoot) return g;
            }
            return -1; // Không tìm thấy căn nguyên thủy
        }

        // Hàm lấy các ước số nguyên tố của n
        function getPrimeFactors(n) {
            const factors = new Set();
            while (n % 2 === 0) {
                factors.add(2);
                n = Math.floor(n / 2);
            }
            for (let i = 3; i * i <= n; i += 2) {
                while (n % i === 0) {
                    factors.add(i);
                    n = Math.floor(n / i);
                }
            }
            if (n > 2) factors.add(n);
            return Array.from(factors);
        }

        // Chuyển đổi chuỗi thành số dựa trên mã hóa Base64
        function stringToNumber(str) {
            const buffer = new TextEncoder().encode(str); // Mã hóa chuỗi thành bytes
            let number = 0;
            for (let i = 0; i < buffer.length; i++) {
                number = number * 256 + buffer[i];  // Tạo một số duy nhất từ các bytes
            }
            return number;
        }

        // Chuyển đổi số thành chuỗi
        function numberToString(num) {
            let str = '';
            while (num > 0) {
                const byte = num % 256;
                str = String.fromCharCode(byte) + str; // Chuyển mỗi byte thành ký tự
                num = Math.floor(num / 256);
            }
            return str;
        }

        // Hàm tính lũy thừa mô đun
        function modExp(base, exp, mod) {
            let result = 1;
            base = base % mod;
            while (exp > 0) {
                if (exp % 2 === 1) {
                    result = (result * base) % mod;
                }
                exp = Math.floor(exp / 2);
                base = (base * base) % mod;
            }
            return result;
        }

        // Hàm tính nghịch đảo mô đun (Sử dụng Thuật toán Euclid mở rộng)
        function modInverse(a, m) {
            let m0 = m, t, q;
            let x0 = 0, x1 = 1;
            if (m === 1) return 0;
            while (a > 1) {
                q = Math.floor(a / m);
                t = m;
                m = a % m;
                a = t;
                t = x0;
                x0 = x1 - q * x0;
                x1 = t;
            }
            if (x1 < 0) x1 += m0;
            return x1;
        }

        // Tạo khóa công khai
        function generatePublicKey(p, g, a) {
            const h = modExp(g, a, p); // h = g^a mod p
            return { p, g, h };
        }

        // Mã hóa
        function encrypt(p, g, h, m, k) {
            const c1 = modExp(g, k, p); // c1 = g^k mod p
            const s = modExp(h, k, p);  // s = h^k mod p
            const c2 = (m * s) % p;     // c2 = m * s mod p
            return { c1, c2 };
        }

        // Giải mã
        function decrypt(p, a, c1, c2) {
            const s = modExp(c1, a, p);     // s = c1^a mod p
            const sInv = modInverse(s, p);  // s^(-1) mod p
            const m = (c2 * sInv) % p;      // m = c2 * s^(-1) mod p
            return m;
        }

        // Mã hóa và giải mã chuỗi
        function handleEncryption() {
            const p = generateRandomPrime(1000, 2000); // Sinh số nguyên tố ngẫu nhiên
            const g = findPrimitiveRoot(p); // Tìm căn nguyên thủy của p

            // Sinh khóa bí mật và số ngẫu nhiên
            const a = randomInt(1, p - 1); // Khóa bí mật a
            const k = randomInt(1, p - 1); // Số ngẫu nhiên k

            const message = document.getElementById("message").value;

            // Chuyển đổi chuỗi thành số
            const m = stringToNumber(message);

            // Tạo khóa công khai
            const { h } = generatePublicKey(p, g, a);
            document.getElementById("publicKey").innerText = `Khóa công khai: (p = ${p}, g = ${g}, h = ${h})`;
            document.getElementById("privateKey").innerText = `Khóa bí mật: a = ${a}`;
            document.getElementById("plainNum").innerText = `Số rõ: m = ${m % p}`;

            // Mã hóa
            const { c1, c2 } = encrypt(p, g, h, m, k);
            document.getElementById("cipherText").innerText = `Bản mã: (c1 = ${c1}, c2 = ${c2})`;

            // Lưu lại c1, c2 và khóa để giải mã
            document.getElementById("c1").value = c1;
            document.getElementById("c2").value = c2;
            document.getElementById("aDecrypt").value = a;
            document.getElementById("pDecrypt").value = p;
           
        }

        // Xử lý giải mã khi người dùng nhấn nút "Giải mã"
        function handleDecryption() {
            const p = parseInt(document.getElementById("pDecrypt").value);
            const a = parseInt(document.getElementById("aDecrypt").value);
            const c1 = parseInt(document.getElementById("c1").value);
            const c2 = parseInt(document.getElementById("c2").value);

            // Giải mã
            const m = decrypt(p, a, c1, c2);

            // In ra số của bản rõ
            document.getElementById("decryptedMessage").innerText = `Số của bản rõ sau giải mã: ${m % p}`;
        }
    </script>
</head>
<body>
    <h1>Mã hóa và Giải mã bằng ElGamal</h1>

    <h2>Tạo khóa và Mã hóa</h2>
    <label for="message">Nhập chuỗi cần mã hóa: </label>
    <input type="text" id="message" required><br><br>

    <button onclick="handleEncryption()">Mã hóa</button>

    <h3 id="publicKey"></h3>
    <h3 id="privateKey"></h3>
    <h3 id="plainNum"></h3>
    <h3 id="cipherText"></h3>

    <h2>Giải mã</h2>
    <label for="c1">Nhập c1 (bản mã): </label>
    <input type="number" id="c1" required><br><br>

    <label for="c2">Nhập c2 (bản mã): </label>
    <input type="number" id="c2" required><br><br>

    <label for="aDecrypt">Nhập khóa bí mật a: </label>
    <input type="number" id="aDecrypt" required><br><br>

    <label for="pDecrypt">Nhập số nguyên tố p: </label>
    <input type="number" id="pDecrypt" required><br><br>

    <button onclick="handleDecryption()">Giải mã</button>

    <h3 id="decryptedMessage"></h3>
    <a href="main.html" class="back-link">Back to Home</a>
</body>
</html>
